
    <div class="SubModule">
    	 <listview uniqueid="courses_listview">
            <listviewhead>
                <listviewheading>
                    Courses
                </listviewheading>
                <listviewtoolbar>
                    <listviewbutton icon="plus-circle" onclick="w_add_course"></listviewbutton>
                </listviewtoolbar>
            </listviehead>
            <listviewheaders>
                <listviewheader width="50%" sortable="sortable" name="Coursename">Course name</listviewheader>
                <listviewheader width="40%" sortable="sortable" name="DateCreated">Date created</listviewheader>
                <listviewheader width="10%" name="Buttons" align="right">&nbsp;</listviewheader>
            </listviewheaders>
            <listviewrows onload="w_reload_courses">
            </listviewrows>
        </listview>
    </div>
     
    <script>
        Application.submodules.courses = {
            init()
            {
            	// Adding a new course
            	ccAddCallback( 'w_add_course', function( data )
            	{
            		let m = new Module( 'system' );
            		m.onExecuted = function( e, d )
            		{
            			// Bail!
		        		if( e != 'ok' ) return;
		        		
		        		let data = JSON.parse( d );
		        		
		        		let v = new View({
		                   title: "Edit course",
		                   width: 1200,
		                   height: 900
		                });
		                
		                v.onClose = function()
		                {
		                	ccFactory.getElementByUniqueId( 'courses_listview' ).onload();
		                }

		                // Create a menu
		                let myMenu = [
		                {
		                    name: 'File',
		                    items: [
		                        {
		                            name: 'Save',
		                            command: 'save',
		                            scope: 'local'
		                        },
		                        {
		                            name: 'Quit',
		                            command: 'quit'
		                        }
		                    ]
		                }
		                ];

		                // Number of courses
		                let dId = document.querySelectorAll(
		                    '.SubModule .HRow'
		                ).length;

		                // Add the menu to the view window
		                v.setMenuItems( myMenu );
		                
		               	let f = new File('Progdir:Templates/main.html');
		                f.onLoad = function( dd )
		                {
		                    v.setContent( dd, function()
		                    {
		                        v.sendMessage( { 
	                                command: 'loadCourse',
                                    courseId: data.ID
		                        } );
		                    } );
		                }
		                f.load();
		            }
		            m.execute( 'appmodule', {
		            	appName: 'CourseCreator',
		            	command: 'newcourse'
		            } );
            	} );
                
                ccAddCallback( 'w_reload_courses', function( listview )
                {
		            // Refreshing courses
		            let m = new Module( 'system' );
		            m.onExecuted = function( e, d )
		            {
		                if( e != 'ok' )
		                {
		                	listview.clearRows();
		                    ge( 'PanelMain' ).classList.remove( 'SectionLoading' );
		                    return;
		                }
		                
		                // Convert JSON response into something listview reads
		                let ls = JSON.parse( d );
		                let out = [];
		                for( let a = 0; a < ls.length; a++ )
		                {
		                	out.push( [ {
                    			type:     'string',
                    			extras:   '<picture type="icon" width="22px" height="22px" icon="star-half-full" border-size="2" shape="circle"></picture>&nbsp;',
                    			value:    ls[a].Name,
                    			onclick:  'course_click_' + a,
                    			onchange: 'course_change_' + a,
                    			uniqueid: 'courserow_' + a
                        	}, {
                    			type:     'string',
                    			value:    ls[a].DateCreated,
                    			onclick:  'course_click_' + a
                        	},
                        	{
                    			type:     'string',
                    			align:    'right',
                    			extras:   '<picture type="icon" width="22px" height="22px" icon="pencil-square" onclick="course_edit_' + a + '"></picture>' +
                                          '<picture type="icon" width="22px" height="22px" icon="remove" onclick="course_remove_' + a + '"></picture>',
                    			value:    '',
                    			onclick:  'course_click_' + a
                        	} ] );
                        	
                        	( function( id )
                        	{
		                    	ccAddCallback( 'course_edit_' + a, function( element )
		                    	{
		                    		let listview = ccFactory.getElementByUniqueId( 'courses_listview' );
		                    		if( listview )
		                    		{
		                    			listview.editColumnById( 'courserow_' + id );
		                    		}
		                    	} );
		                   	} )( a );
		                   	( function( id, courseId )
                        	{
		                    	ccAddCallback( 'course_remove_' + a, function( element )
		                    	{
		                    		Confirm( 'Are you sure?', 'This will remove the course from active courses.', function( msg )
		                    		{
		                    			if( msg.data )
		                    			{
				                			let lv = ccFactory.getElementByUniqueId( 'courses_listview' );
		                    				let m = new Module( 'system' );
				                			m.onExecuted = function( re, de )
				                			{
						            			lv.onload();
						            		}
						            		m.execute( 'appmodule', {
						            			appName: 'CourseCreator',
												command: 'submodule',
												vars: {
													method: 'coursetotrash',
													submodule: 'courses',
													courseId: courseId
												}
						            		} );
		                    			}
		                    		} );
		                    	} );
		                   	} )( a, ls[a].ID );
                        	
                        	( function( id, rowId )
                        	{
                        		ccAddCallback( 'course_change_' + id, function( dataSet, listview )
                        		{
                        			let m = new Module( 'system' );
                        			m.onExecuted = function( re, de )
                        			{
		                    			listview.refreshRows();
		                    		}
		                    		m.execute( 'appmodule', {
		                    			appName: 'CourseCreator',
										command: 'submodule',
										vars: {
										    method: 'setcoursename',
										    submodule: 'courses',
										    coursename: dataSet.value,
										    courseId: rowId
										}
		                    		} );
                        		} );
                        	} )( a, ls[a].ID );
                        	
                        	( function( r )
                        	{
		                    	ccAddCallback( 'course_click_' + a, function( data )
		                    	{
		                    		let v = new View({
	                                   title: "Edit course - " + r.Name,
	                                   width: 1200,
	                                   height: 900
	                                });

	                                // Create a menu
	                                let myMenu = [
	                                {
	                                    name: 'File',
	                                    items: [
	                                        {
	                                            name: 'Save',
	                                            command: 'save',
	                                            scope: 'local'
	                                        },
	                                        {
	                                            name: 'Quit',
	                                            command: 'quit'
	                                        }
	                                    ]
	                                }
	                                ];
	                                // Add the menu to the view window
	                                v.setMenuItems( myMenu );
	                                
	                                v.onClose = function()
	                                {
	                                	listview.onload();
	                                }
	                                
	                                let f = new File('Progdir:Templates/main.html');
	                                f.onLoad = function( data ){
	                                    v.setContent( data, function(){         
	                                        v.sendMessage(
	                                            { 
	                                                command: 'loadCourse',
	                                                courseId: r.ID
	                                            }
	                                        );
	                                    });
	                                }
	                                f.load();
		                    	} );
		                   	} )( ls[ a ] );
		                }
		                
		                listview.setRowData( out );
		                
		                ge( 'PanelMain' ).classList.remove( 'SectionLoading' );
		            }
		            m.execute( 'appmodule', {
		                appName: 'CourseCreator',
		                command: 'submodule',
		                vars: {
		                    method: 'courses',
		                    submodule: 'courses'
		                }
		            } );
		        } );
		        
		        ccInitializeGUI();
            }
        };
        Application.submodules.courses.init();
    </script>


