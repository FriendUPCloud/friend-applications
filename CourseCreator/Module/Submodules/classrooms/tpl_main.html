<!--
    <div class="SubModule">
        <div class="ContentHeader">
            <h2>
                Classrooms
            </h2>
            <div class="Left">
                <div class="Buttons">
                    <div class="HeaderButton IconSmall fa-plus-circle MousePointer" onclick="Application.submodules.classrooms.create()"></div>
                    <!-<div class="HeaderButton IconSmall fa-navicon MousePointer"></div>->
                </div>
                <input type="text" placeholder="Search"/>
            </div>
        </div>
        <div class="ContentListHeaders">
            <div class="HRow EditRow">
                <div class="HContent25 Ellipsis FloatLeft">Class name</div>
                <div class="HContent10 Ellipsis FloatLeft">Users</div>
                <div class="HContent15 Ellipsis FloatLeft">Status</div>
                <div class="HContent20 Ellipsis FloatLeft">Owner</div>
                <div class="HContent10 Ellipsis FloatLeft">End date</div>
                <div class="HContent20 Ellipsis FloatLeft">Date created</div>
            </div>
        </div>
        <div class="ContentBlock">
            <div id="ClassroomContent"></div>
        </div>
    </div>
-->
<group responsive-logic="sidescroll">
        <columns gap="10px" height="100%">
            <column scrollable="smooth">
                <listview>
                    <listviewhead>
                        <listviewheading>
                            Classrooms
                        </listviewheading>
                        <listviewtoolbar>
                            <listviewbutton icon="plus-circle" onclick="cl_add_room"></listviewbutton>
                        </listviewtoolbar>
                    </listviehead>
                    <listviewheaders>
                        <listviewheader width="25%" sortable="sortable" name="Name">Name</listviewheader>
                        <listviewheader width="10%" sortable="sortable" name="Users">Users</listviewheader>
                        <listviewheader width="15%" sortable="sortable" name="Status">Status</listviewheader>
                        <listviewheader width="15%" sortDefault="sortDefault" sortOrder="ZA" sortable="sortable" name="StartDate">Start Date</listviewheader>
                        <listviewheader width="15%" sortable="sortable" name="EndDate">End Date</listviewheader>
                        <listviewheader width="20%" sortable="sortable" name="Owner">Owner</listviewheader>
                    </listviewheaders>
                    <listviewrows onload="cl_load_rooms">
                    </listviewrows>
                </listview>
            </column>
            <column scrollable="smooth">
                <div id="RoomDetails" class="EditPane"></div>
            </column>
        </columns>
    </group>
    
    <script>
        Application.submodules.classrooms = {
            init()
            {
                const self = this;
                console.log( 'classrooms init', this );
                let m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    console.log( 'classrooms / classroom', [ e, d, this ]);
                    
                    /*
                    if( e != 'ok' )
                    {
                        //ge( 'ClassroomContent' ).innerHTML = '<p>No classrooms currently found.</p>';
                        //ge( 'PanelMain' ).classList.remove( 'SectionLoading' );
                        
                        //self.refreshRooms();
                        console.log( 'classroom fail' );
                        return;
                    }
                    */
                    //ge( 'ClassroomContent' ).innerHTML = '';
                   
                    //ge( 'PanelMain' ).classList.remove( 'SectionLoading' );
                    
                    //self.refreshRooms();
                    
                    ccAddCallback( 'cl_add_room', e =>
                    {
                        console.log( 'cl_add_room', [ e, this ]);
                        Application.submodules.classrooms.create();
                    });
                    
                    ccAddCallback( 'cl_load_rooms', lv =>
                    {
                        console.log( 'cl_load_rooms', lv );
                        self.rooms = lv;
                        self.refreshRooms();
                    });
                    
                    ccInitializeGUI();
                }
                m.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        method: 'classrooms',
                        submodule: 'classrooms'
                    }
                } );
            },
            // Add a news item to the classroom
            addNews()
            {
            	let self = this;
            	if( ge( 'ClassroomId' ) && ge( 'NewsMessage' ).value.length )
            	{
            		const rid = ge( 'ClassroomId' ).value;
            		
		        	let m = new Module( 'system' );
		        	m.onExecuted = function( me, md )
		        	{
		        		ge( 'NewsMessage' ).value = '';
		        		self.refreshNewsItems();
		        	}
		        	m.execute( 'appmodule', {
		        		appName: 'CourseCreator',
		        		command: 'submodule',
		        		vars: {
		        			method: 'addnews',
		        			submodule: 'classrooms',
		        			message: ge( 'NewsMessage' ).value,
		        			classroomId: rid
		        		}
		        	} );
		        }
            },
            removeNewsItem( newsid )
            {
            	let self = this;
            	Confirm( 'Are you sure?', 'This will remove the news item from the classroom.', function( res )
            	{
            		if( res.data )
            		{
		        		let m = new Module( 'system' );
		        		m.onExecuted = function( me, md )
		        		{
		        			self.refreshNewsItems();
		        		}
		        		m.execute( 'appmodule', {
							appName: 'CourseCreator',
							command: 'submodule',
							vars: {
								method: 'removenews',
								submodule: 'classrooms',
								newsId: newsid
							}
						} );
					}
            	} );
            },
            // Get the list of newsitems for the classroom and list them
            refreshNewsItems()
            {
            	if( !ge( 'ClassroomId' ) )
            	{
            		return;
            	}
        		const rid = ge( 'ClassroomId' ).value;
        		
        		let m = new Module( 'system' );
        		m.onExecuted = function( me, md )
        		{
        			if( me != 'ok' ) 
        			{
        				ge( 'NewsMessages' ).innerHTML = '<p>There are no news messages for this classroom.</p>';
        				return;
        			}
        			let messages = JSON.parse( md );
        			
        			// Clean shop
        			let nm = ge( 'NewsMessages' );
        			nm.innerHTML = '';
        			
        			for( let a = 0; a < messages.length; a++ )
        			{
        				let ms = document.createElement( 'div' ); ms.className = 'NewsContainer';
        				let dt = document.createElement( 'div' ); dt.className = 'NewsData';
        				let cn = document.createElement( 'div' ); cn.className = 'NewsContent';
        				dt.innerHTML = friendUP.tool.getChatTime( messages[a].DateUpdated ) +
        								' <span class="MarginLeft FloatRight IconSmall fa-remove MousePointer" onclick="Application.submodules.classrooms.removeNewsItem(\'' + messages[a].ID + '\')"></span>';
        				cn.innerHTML = messages[a].Message;
        				
        				ms.appendChild( dt );
        				ms.appendChild( cn );
        				nm.appendChild( ms );
        			}
        		}
        		m.execute( 'appmodule', {
        			appName: 'CourseCreator',
        			command: 'submodule',
        			vars: {
        				method: 'getnews',
        				submodule: 'classrooms',
        				classroomId: rid
        			}
        		} );
            },
            refreshRooms( lv )
            {
                const self = this;
                console.log( 'refreshrooms', [ typeof( lv ), self ]);
                if ( 'function' == typeof( lv ))
                    console.trace( 'refreshrooms called with callback!!!!!!!!!??', lv );
                
                if ( null == lv ) {
                    if ( null == self.rooms )
                        throw new Error( 'lv not inited yet' );
                    
                    lv = self.rooms;
                }
                
                let m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    console.log( 'refreshclassrooms', JSON.parse( d ));
                    if( e != 'ok' )
                    {
                        console.log( 'refreshrooms not ok', [ e, d ]);
                        return;
                    }
                    else
                    {
                        let ls = JSON.parse( d );
                        let str = '';
                        console.log( 'refreshrooms', ls );
                        const rows = [];
                        for( let a = 0; a < ls.length; a++ )
                        {
                            console.log( 'room', ls[a]);
                            let status = '';
                            let users = ls[a].Users || + '0';
                            let owner = ls[a].Owner ? ls[a].Owner : '-';
                            let end = ls[a].DateEnd ? ls[a].DateEnd : null;
                            let start = ls[a].DateStart ? ls[a].DateStart : null;
                            let nam = ls[a].Name ? ls[a].Name : '&nbsp;';
                            
                            if ( ls[a].Status == 0 )
                            {
                                status = 'Unsaved';
                            }
                            else
                            {
                                status = 'Planned';
                                const now = Date.now();
                                const sd = Date.parse( start );
                                const ed = Date.parse( end );
                                if ( now > sd )
                                    status = 'Active';
                                if ( now > ed )
                                    status = 'Closed';
                            }
                            
                            const r = [
                                {   // room name
                                    type  : 'string',
                                    value : nam,
                                },
                                {   // # of users
                                    type  : 'string',
                                    value : users,
                                },
                                {   // Status
                                    type  : 'string',
                                    value : status,
                                },
                                {   // start date
                                    type  : 'string',
                                    value : start.split(' ')[0],
                                },
                                {   // end date
                                    type  : 'string',
                                    value : end.split(' ')[0],
                                },
                                {   // owner
                                    type  : 'string',
                                    value : owner,
                                },
                            ];
                            
                            r.onclick = 'cl_edit_room_' + a;
                            const rId = ls[a].ID;
                            ccAddCallback( r.onclick, ( ...args ) => {
                                console.log( 'row onclick handler', [ args, rId ]);
                                Application.submodules.classrooms.editClassroom( rId );
                            });
                            
                            rows[a] = r;
                            
                            /*
                            switch( status )
                            {
                                case 'Unsaved':
                                    status = '<span class="Status Unsaved">Unsaved</span>';
                                    break;
                                case 'Planned':
                                    status = '<span class="Status Planned">Planned</span>';
                                    break;
                                case 'Closed':
                                    status = '<span class="Status Closed">Closed</span>';
                                    break;
                                case 'Active':
                                    status = '<span class="Status Active">Active</span>';
                                    break;
                            }
                            
                            str += '<div class="HRow EditRow" row-id="' + ls[a].ID + '">\
                                <div class="HContent25 Ellipsis FloatLeft">' + nam + '</div>\
                                <div class="HContent10 Ellipsis FloatLeft">' + users + '</div>\
                                <div class="HContent15 Ellipsis FloatLeft TextCenter">' + status + '</div>\
                                <div class="HContent20 Ellipsis FloatLeft">' + owner + '</div>\
                                <div class="HContent10 Ellipsis FloatLeft">' + end + '</div>\
                                <div class="HContent20 Ellipsis FloatLeft">' + ls[a].DateCreated + '</div>\
                            </div>';
                            */
                        }
                        
                        lv.setRowData( rows );
                        //ge( 'ClassroomContent' ).innerHTML = str;
                        //let rows = ge( 'ClassroomContent' ).getElementsByClassName( 'HRow' );
                        /*
                        for( let a = 0; a < rows.length; a++ )
                        {
                            ( function( r ) {
                                r.onclick = function()
                                {
                                    Application.submodules.classrooms.editClassroom( this.getAttribute( 'row-id' ) );
                                }
                            } )( rows[a] );
                        }
                        */
                    }
                    //if( cbk ) cbk();
                }
                m.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        method: 'refreshrooms',
                        submodule: 'classrooms'
                    }
                } );
            },
            setModuleState( state )
            {
                if( this.moduleStateTimeo )
                {
                    clearTimeout( this.moduleStateTimeo );
                }
                switch( state )
                {
                    case 'Editing':
                        document.body.classList.remove( 'Saved' );
                        document.body.classList.remove( 'Saving' );
                        document.body.classList.add( 'Editing' );
                        break;
                    case 'Saving':
                        document.body.classList.remove( 'Saved' );
                        document.body.classList.remove( 'Editing' );
                        document.body.classList.add( 'Saving' );
                        break;
                    case 'Saved':
                    default:
                        document.body.classList.remove( 'Saving' );
                        document.body.classList.remove( 'Editing' );
                        document.body.classList.add( 'Saved' );
                        this.moduleStateTimeo = setTimeout( function()
                        {
                            document.body.classList.remove( 'Saving' );
                            document.body.classList.remove( 'Editing' );
                            document.body.classList.remove( 'Saved' );
                        }, 500 );
                        break;
                }
            },
            // Just make sure it exists
            checkEditPane()
            {
                if( !this.editPane )
                {
                    /*
                    let d = document.createElement( 'div' );
                    d.className = 'EditPane';
                    ge( 'PanelMain' ).appendChild( d );
                    this.editPane = d;
                    */
                    this.editPane = ge( 'RoomDetails' );
                }
                else
                {
                    this.editPane.innerHTML = '';
                }
            },
            // Create a new classroom
            create()
            {
                const self = this;
                console.log( 'classroom create', {
                    ID   : self.ID,
                });
                //self.editRoomId = null;
                this.checkEditPane();
                
                const m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    if( e != 'ok' )
                    {
                        return document.body.classList.remove( 'Editmode' );
                    }
                    console.log( 'create things', [ e, d ]);
                    
                    let cl = new Module( 'system' );
                    cl.onExecuted = function( cle, cld )
                    {
                        console.log( 'create courselist', cld );
                        // add courses list
                        let courses = [ { ID: 0, Name: 'No course specified.' } ];
                        if ( e == 'ok' )
                        {
                            let t = JSON.parse( cld );
                            for( let b = 0; b < t.length; b++ )
                                courses.push( t[b] );
                        }
                        
                        let cstr = '';
                        for( let z = 0; z < courses.length; z++ )
                        {
                            let sel = '';
                            cstr += '<option value="' + courses[ z ].ID + '"' + sel + '>' + courses[ z ].Name + '</option>';
                        }
                        d = d.split( '{courseList}' ).join( cstr );
                        
                        // Reset the template
                        let vars = { 'Name': '', 'StartDate': '', 'EndDate': '' };
                        for( let a in vars )
                            d = d.split( '{' + a + '}' ).join( vars[ a ] );
                        
                        self.editPane.innerHTML = d;
                        
                        ge( 'cl_edit_save' ).classList.toggle( 'ccHidden', false );
                        ge( 'cl_edit_cancel' ).classList.toggle( 'ccHidden', false );
                        document.body.classList.add( 'Editmode' );
                        
                        ccAddCallback( 'cr_edit_list_users', lv =>
                        {
                            console.log( 'cr_edit_list_users', lv );
                            self.ulv = lv;
                            self.ulv.hide();
                        });
                        
                        ccAddCallback( 'cr_edit_add_users_list', lv =>
                        {
                            console.log( 'cr_edit_add_users_list', lv );
                            self.auv = lv;
                            self.auv.hide();
                        });
                        
                        ccInitializeGUI();
                        
                    }
                    cl.execute( 'appmodule', {
                        appName: 'CourseCreator',
                        command: 'submodule',
                        vars: {
                            method: 'classroomcourses',
                            submodule: 'classrooms',
                            classroomId: null,
                        }
                    } );
                }
                m.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        method: 'loadtemplate',
                        submodule: 'classrooms',
                        template: 'create'
                    }
               });
            },
            // Edit an existing classroom
            editClassroom( rowId )
            {
                const self = this;
                console.log( 'editClassroom', {
                    rowId : rowId,
                    ID    : self.ID,
                });
                this.checkEditPane();
                
                let u = new Module( 'system' );
                u.onExecuted = function( ue, ud )
                {
                    if( ue == 'ok' )
                    {
                        let data = JSON.parse( ud );
                        console.log( 'getClassroom back', [ ue, data ]);
                        let m = new Module( 'system' );
                        m.onExecuted = function( e, d )
                        {
                            console.log( 'classroom create back', [ e, d ]);
                            if( e != 'ok' )
                            {
                                return v.close();
                            }
                            
                            for( let i in data )
                            {
                                d = d.split( '{' + i + '}' ).join( data[ i ] );
                            }
                            
                            let p = new Module( 'system' );
                            p.onExecuted = function( pe, pd )
                            {
                            	let courses = [ { ID: 0, Name: 'No course specified.' } ];
                            	if( pe == 'ok' )
                            	{
                            		let t = JSON.parse( pd );
                            		for( let b = 0; b < t.length; b++ )
                            			courses.push( t[b] );
                            	}
                            	
                                console.log( 'classroom courses', [ pe, courses ]);
                            	// Create courses string
                            	let cstr = '';
                            	for( let z = 0; z < courses.length; z++ )
                            	{
                            		let sel = '';
                            		if( courses[ z ].ID == data.CourseID )
                            			sel = ' selected="selected"';
                            		cstr += '<option value="' + courses[ z ].ID + '"' + sel + '>' + courses[ z ].Name + '</option>';
                            	}
                            	d = d.split( '{courseList}' ).join( cstr );
                            	
		                        self.ID = rowId;
		                        self.editPane.innerHTML = d;
                                
		                        ge( 'ClassroomId' ).value = rowId;
                                if ( null != data.Status )
                                    dateStatus = window.parseInt( data.Status );
                                
                                console.log( 'class room status', data.Status );
                                
                                ge( 'ClassroomStatus' ).value = data.Status || 0;
                                    
                                if ( !data.Status ) {
                                    ge( 'cl_edit_save' ).classList.toggle( 'ccHidden', false );
                                    ge( 'cl_edit_cancel' ).classList.toggle( 'ccHidden', false );
                                }
		                        document.body.classList.add( 'Editmode' );
                                
                                ccAddCallback( 'cr_users_filter', ( lv, value ) => {
                                    console.log( 'cr_users_filter', [ lv, value, self.usrListMode ]);
                                    self.addUsrFilter = value;
                                    if ( 'auv' == self.usrListMode )
                                        return;
                                    
                                    Application.submodules.classrooms.refreshClassroomUsers( lv );
                                });
                                
                                ccAddCallback( 'cr_add_users_filter', ( lv, value ) => {
                                    console.log( 'cr_add_users_filter', [ lv, value, self.usrListMode ]);
                                    self.usrListFilter = value;
                                    if ( 'ulv' == self.usrListMode )
                                        return;
                                    
                                    Application.submodules.classrooms.populateAddUserList( rowId );
                                });
                                
                                ccAddCallback( 'cr_edit_add_users_btn', lv => 
                                {
                                    console.log( 'cr_edit_add_users_btn', lv );
                                    self.ulv.hide();
                                    self.auv.show();
                                    self.usrListMode = 'auv';
                                    self.ulv.clearRows();
                                    Application.submodules.classrooms.populateAddUserList( rowId );
                                });
                                
                                ccAddCallback( 'cr_edit_list_users', lv =>
                                {
                                    console.log( 'cr_edit_list_users', lv );
                                    self.ulv = lv;
                                    self.usrListMode = 'ulv';
                                    if ( !data.Status )
                                        self.ulv.hide();
                                    
                                    Application.submodules.classrooms.refreshClassroomUsers( lv );
                                });
                                
                                ccAddCallback( 'cr_edit_show_user_list_btn', lv =>
                                {
                                    console.log( 'cr_edit_show_user_list_btn', lv );
                                    self.auv.hide();
                                    self.ulv.show();
                                    self.usrListMode = 'ulv';
                                    self.auv.clearRows();
                                    Application.submodules.classrooms.refreshClassroomUsers( self.ulv );
                                });
                                
                                ccAddCallback( 'cr_edit_add_users_list', lv =>
                                {
                                    console.log( 'cr_edit_add_users_list', lv );
                                    self.auv = lv;
                                    self.auv.hide();
                                    
                                });
                                
                                ccInitializeGUI();
                                
                                if ( data.Status )
                                    ge( 'cl_news_bulleting' ).classList.toggle( 'ccHidden', false );
                                   
                                self.refreshNewsItems();
                                
		                    }
		                    p.execute( 'appmodule', {
		                    	appName: 'CourseCreator',
		                    	command: 'submodule',
		                    	vars: {
		                    		method: 'classroomcourses',
		                    		submodule: 'classrooms',
		                    		classroomId: rowId
		                    	}
		                    } );
                        }
                        m.execute( 'appmodule', {
                            appName: 'CourseCreator',
                            command: 'submodule',
                            vars: {
                                method: 'loadtemplate',
                                submodule: 'classrooms',
                                template: 'create'
                            }
                       } );
                    }
                }
                console.log( 'rowId', rowId );
                u.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        method: 'getclassroom',
                        submodule: 'classrooms',
                        classroomId: rowId
                    }
                } );
            },
            refreshClasses( data )
            {
                this.refreshRooms();
            },
            
            viewCourse()
            {
                const rid = ge( 'ClassroomId' ).value;
                console.log( 'viewCourse', rid );
                const gc = new Module( 'system' );
                gc.onExecuted = ( s, d ) =>
                {
                    console.log( 'viewCourse back', [ s, d ]);
                    let res = null;
                    try {
                        res = JSON.parse( d );
                    } catch( ex ) {
                        console.log( 'ex', ex );
                        return;
                    }
                    console.log( 'viewCourse res', res );
                    const v = new View({
                        title  : 'View Course',
                        width  : 800,
                        height : 900,
                    });
                    v.onClose = function()
                    {
                        console.log( 'viewer closed' );
                    }
                    
                    const f = new File('Progdir:Templates/viewer.html' );
                    f.onLoad = d =>
                    {
                        console.log( 'file loaded', d );
                        v.setContent( d, () => {
                            console.log( 'set content done', res.CourseID );
                            v.sendMessage(
                                {
                                    command : 'loadCourse',
                                    courseId : res.CourseID,
                                }
                            )
                        });
                    }
                    f.load();
                    
                }
                gc.execute( 'appmodule', {
                    appName : 'CourseCreator',
                    command : 'submodule',
                    vars    : {
                        method      : 'getclassroom',
                        submodule   : 'classrooms',
                        classroomId : rid,
                    }
                } );
            },
            
            moveToTrash()
            {
            	const rid = ge( 'ClassroomId' ).value;
            	let self = this;
            	
            	Confirm( 'Are you sure?', 'This will put this classroom in trash, and it will be invisible to users.', function( result )
            	{
            		if( result.data == true )
            		{
            			let m = new Module( 'system' );
            			m.onExecuted = function( me, md )
            			{
            				if( me == 'ok' )
            				{
		        				document.body.classList.remove( 'Editmode' );
		        				self.refreshRooms();
		        			}
		        			else
		        			{
		        				Alert( 'Failed to move to trash', 'The course could not be moved to trash.' );
		        			}
            			}
            			m.execute( 'appmodule', {
            				appName: 'CourseCreator',
            				command: 'submodule',
            				vars: {
            					method: 'movetotrash',
            					submodule: 'classrooms',
            					classroomId: rid
            				}
            			} );
            		}
            	} );
            },
            
            executeSaveTheRoom()
            {
                console.log( 'executeSaveTheRoom' );
                let self = this;
                
                self.setModuleState( 'Editing' );
                
                // We are pending (and will save once done)
                if( this.savePending )
                {
                    return;
                }
                // First save
                else if( !this.ID )
                {
                    this.saveTheRoom();
                    this.savePending = true;
                }
                // Delayed to not do too many saves
                else
                {
                    if( this.saver ) clearTimeout( this.saver );
                    this.saver = setTimeout( function()
                    {
                        self.saver = null;
                        self.saveTheRoom();
                    }, 750 );
                }
            },
            
            executeFinalizeTheRoom()
            {
                const self = this;
                console.log( 'executeFinalizeTheRoom', {
                    roomid : ge( 'ClassroomId' ).value,
                    status : ge( 'ClassroomStatus' ).value,
                });
                self.setModuleState( 'Editing' );
                if ( null == self.saver )
                    clearTimeout( self.saver );
                
                self.saveTheRoom( 1 );
            },
            
            executeRemoveTheRoom()
            {
                const self = this;
                const rid = ge( 'ClassroomId' ).value;
                console.log( 'executeRemoveTheRoom', rid );
                const c = new Module( 'system' );
                c.onExecuted = ( s, d ) => {
                    console.log( 'cancel room back', [ s, d ]);
                    const res = JSON.parse( d );
                    console.log( 'cancel room res', res );
                    self.refreshRooms();
                    document.body.classList.remove( 'Editmode' );
                };
                c.execute( 'appmodule', {
                    appName : 'CourseCreator',
                    command : 'submodule',
                    vars    : {
                        method      : 'removeclassroom',
                        submodule   : 'classrooms',
                        classroomId : rid,
                    },
                } );
            },
            
            saveTheRoom( status )
            {
                let self = this;
                if ( null == status )
                    status = ge( 'ClassroomStatus' ).value;
                else
                    ge( 'ClassroomStatus' ).value = status;
                
                console.log( 'savetheroom', [ ge( 'ClassroomId' ).value, status ] );
                const name = ge( 'className' ).value;
                if ( !name )
                    return;
                
                self.setModuleState( 'Saving' );
                const edEl = ge( 'endDate' );
                const sd = ge( 'startDate' ).value;
                const ed = ge( 'endDate' ).value;
                const sa = sd.split( '-' );
                const ea = ed.split( '-' );
                
                for( let i = 0; i < sa.length ; )
                {
                    const s = parseInt( sa[ i ], 10 );
                    const e = parseInt( ea[ i ], 10 );
                    console.log( 'comparing', [ i, s, e ]);
                    if ( s > e )
                    {
                        self.setModuleState( 'Editing' );
                        edEl.classList.toggle( 'Alert-Border', true );
                        Confirm( 
                            'Invalid date', 
                            'End date can not be before Start date', 
                            ( res ) => {
                                const choice = res.data;
                                console.log( 'Confirm back', res, choice );
                                if ( !choice )
                                {
                                    // do nothing
                                }
                                if ( true === choice )
                                {
                                    // move end date to start date
                                    ge( 'endDate' ).value = ge( 'startDate' ).value;
                                }
                                if ( '???' == choice )
                                {
                                    // move start date to end date
                                    ge( 'startDate' ).value = ge( 'endDate' ).value;
                                }
                                
                                self.saveTheRoom();
                            }, 
                            'Move End date', 
                            'Ok', //confirmCancelText, 
                            'Move Start date', //thirdButtonText, 
                            '???', //thirdButtonReturn 
                        );
                        return;
                    }
                    else
                    {
                        if ( s < e )
                        {
                            i = sa.length;
                        }
                        else
                        {
                            i++;
                        }
                    }
                }
                
                console.log( 'saveTheRoom', {
                    roomid : ge( 'ClassroomId' ).value,
                    name   : name,
                    course : ge( 'classCourses' ).value,
                    start  : sd,
                    end    : ed,
                    status : status,
                });
                edEl.classList.toggle( 'Alert-Border', false );
                
                let m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    if( e == 'ok' )
                    {
                        self.setModuleState( 'Saved' );
                        
                        let res = JSON.parse( d );
                        
                        if ( res.Status != 0 )
                            self.editClassroom( res.ID );
                        else
                        {
                            ge( 'ClassroomId' ).value = res.ID;
                            ge( 'ClassroomStatus' ).value = res.Status;
                        }
                        
                        //return;
                        
                    }
                    else
                    {
                    	// Put back the course
                    	let opts = ge( 'classCourses' ).getElementsByTagName( 'option' );
                    	for( let v = 0; v < opts.length; v++ )
                    	{
                    		if( opts[v].value == 0 )
                    		{
                    			opts[v].selected = 'selected';
                    		}
                    		else
                    		{
                    			opts[v].selected = '';
                    		}
                    	}
                    }
                    if( self.savePending )
                    {
                        self.savePending = null;
                        self.saveTheRoom();
                    }
                    self.refreshRooms();
                    
                    // TODO: Add error
                    self.setModuleState( false );
                    return;
                }
                
                const courseId = ge( 'classCourses' ).value;
                
                m.execute( 'appmodule', {
                    appName : 'CourseCreator',
                    command : 'submodule',
                    vars    : {
                        submodule : 'classrooms',
                        method    : 'saveclassroom',
                        data      : {
                            id        : ge( 'ClassroomId' ).value,
                            name      : name,
                            endDate   : ed,
                            startDate : sd,
                            courseId  : courseId,
                            status    : ( null != status ) ? status : undefined,
                        },
                    },
                } );
            },
            // Refresh list of users assigned to a classroom
            
            refreshClassroomUsers( lv )
            {
                const self = this;
                // We are in a different mode, use findUsers instead!
                /*
                if( ge( 'UserHeader' ).classList.contains( 'Two' ) )
                {
                    return this.findUsers( ge( 'userSearch' ).value );
                }
                */
                
                if ( null == lv )
                    lv = self.ulv;
                
                
                //let keys = ge( 'userSearch' ).value.length > 0 ? ge( 'userSearch' ).value : false;
                let keys = null;
                if ( lv.filters[ 0 ].value )
                    keys = lv.filters[ 0 ].value;
                
                console.log( 'refreshClassroomUsers', [ lv, self.ulv, keys ]);
                let m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    console.log( 'refreshusers', [ e, d ]);
                    if( e == 'ok' )
                    {
                        let js = JSON.parse( d );
                        console.log( 'refreshClassroomUsers', js );
                        const rws = [];
                        let l = js.length;
                        for( ;l; )
                        {
                            l--;
                            let d = new Date();
                            let name = js[l].FullName;
                            let progress = parseInt( js[l].progress );
                            if( isNaN( progress ) ) progress = 0;
                            let status = js[l].Status;
                            let payment = !!js[l].PaymentStatus;
                            console.log( 'payment', payment );
                            if( !payment ) payment = false; else payment = true;
                            console.log( 'payment', payment );
                            let cert = js[l].CertName;
                            let lastLogin = !!js[l].LoginTime ? js[l].LoginTime.split(' ')[0] : '';
                            
                            const cnf =
                            [
                                {
                                    type  : 'string',
                                    value : name,
                                },
                                {
                                    type  : 'string',
                                    value : progress
                                },
                                {
                                    type     : 'checkbox',
                                    value    : payment,
                                    onchange : 'class_user_payment_' + js[l].UserID,
                                },
                                {
                                    type      : ( null == cert ) ? 'button'  : 'string',
                                    value     : ( null == cert ) ? ' Upload' : cert,
                                    iconclass : ( null == cert ) ? 'IconSmall  fa-plus' : undefined,
                                    onclick   : ( null == cert ) ? 'class_user_add_cert_' + js[l].UserID : undefined,
                                },
                                {
                                    type  : 'string',
                                    value : lastLogin,
                                },
                                {
                                    type     : 'checkbox',
                                    value    : true,
                                    onchange : 'class_user_remove_' + js[l].UserID,
                                }
                            ];
                            
                            rws.push( cnf );
                            
                        }
                        
                        lv.setRowData( rws );
                        
                        l = js.length;
                        for( ;l; )
                        {
                            l--;
                            const uid = js[l].UserID;
                            
                            if ( null == js[l].CertName )
                            {
                                
                                ccAddCallback( 'class_user_add_cert_' + js[l].UserID, ( e ) => {
                                    console.log( 'cert upload for class, user', [ 
                                        ge( 'ClassroomId' ).value,
                                        uid,
                                        e,
                                    ]);
                                    Filedialog( null, ( files ) => 
                                    {
                                        const nfo = files[0];
                                        console.log( 'file back', [ files, nfo, uid ]);
                                        if ( null == nfo )
                                            return;
                                        
                                        const cert = {
                                            UserFilePath : nfo.Path,
                                            UserFileName : nfo.Filename
                                        };
                                        // save
                                        const ca = new Module( 'system' );
                                        ca.onExecuted = ( s, d ) => 
                                        {
                                            console.log( 'cert add back', [ s, d ]);
                                            console.log( 'res', JSON.parse( d ));
                                            self.refreshClassroomUsers();
                                        }
                                        
                                        ca.execute( 'appmodule', {
                                            appName : 'CourseCreator',
                                            command : 'submodule',
                                            vars    : {
                                                submodule   : 'users',
                                                method      : 'addcert',
                                                userId      : uid,
                                                classroomId : ge( 'ClassroomId' ).value,
                                                cert        : cert,
                                            },
                                        });
                                    });
                                });
                            }
                            
                            ccAddCallback( 'class_user_payment_' + js[l].UserID, v =>
                            {
                                console.log( 'class_user_payment_', [ ge( 'ClassroomId' ).value,
                                    uid,
                                     v ]);
                                
                                let paid = '';
                                if ( v )
                                    paid = 'paid';
                                
                                const cp = new Module( 'system' );
                                cp.onExecuted = ( s, d ) =>
                                {
                                    console.log( 'paymentstatus back', [ s, d ]);
                                    const res = JSON.parse( d );
                                    console.log( 'paymentstatus res', res );
                                }
                                
                                cp.execute( 'appmodule', {
                                    appName : 'CourseCreator',
                                    command : 'submodule',
                                    vars    : {
                                        method      : 'paymentstatus',
                                        submodule   : 'classrooms',
                                        userId      : uid,
                                        classroomId : ge( 'ClassroomId' ).value,
                                        payment     : paid,
                                    },
                                });
                            });
                            
                            
                            ccAddCallback( 'class_user_remove_' + js[l].UserID, ( e ) => {
                                console.log( 'remove btn for class, user', [
                                    ge( 'ClassroomId' ).value,
                                    uid,
                                    e,
                                ]);
                                let io = new Module( 'system' );
                                io.onExecuted = function( e, d )
                                {
                                    self.refreshClassroomUsers();
                                }
                                io.execute( 'appmodule', {
                                    appName: 'CourseCreator',
                                    command: 'submodule',
                                    vars: {
                                        submodule: 'classrooms',
                                        method: 'removeuser',
                                        classroomId: ge( 'ClassroomId' ).value,
                                        userId: uid,
                                    }
                                } );
                                
                                /*
                                Confirm( 
                                    'Are you sure?',
                                    'This will remove the user from the classroom.',
                                    function( data )
                                    {
                                        if( data.data == true )
                                        {
                                        }
                                    }
                               );
                               */
                            } );
                        }
                        
                        /*
                        let dels = ge( 'ClassroomUsers' ).getElementsByClassName( 'Remove' );
                        for( let j = 0; j < dels.length; j++ )
                        {
                            ( function( btn, userid )
                            {
                                btn.onclick = function()
                                {
                                    Confirm( 
                                        'Are you sure?',
                                        'This will remove the user from the classroom.',
                                        function( data )
                                        {
                                            if( data.data == true )
                                            {
                                                let io = new Module( 'system' );
                                                io.onExecuted = function( e, d )
                                                {
                                                    self.refreshClassroomUsers();
                                                }
                                                io.execute( 'appmodule', {
                                                    appName: 'CourseCreator',
                                                    command: 'submodule',
                                                    vars: {
                                                        submodule: 'classrooms',
                                                        method: 'removeuser',
                                                        classroomId: ge( 'ClassroomId' ).value,
                                                        userId: userid
                                                    }
                                                } );
                                            }
                                        }
                                   );
                                }
                            } )( dels[ j ], dels[ j ].getAttribute( 'userId' ) );
                        }
                        */
                    }
                    else
                    {
                        console.log( 'no users in classroom i guess' );
                        lv.setRowData([]);
                        //ge( 'ClassroomUsers' ).innerHTML = '<div class="HRow EditRow"><div class="HContent100 Ellipsis">This classroom has no users.</div></div>';
                    }
                }
                console.log( 'classroom id ', ge( 'ClassroomId' ).value );
                m.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        submodule: 'classrooms',
                        method: 'refreshusers',
                        classroomId: ge( 'ClassroomId' ).value,
                        keys: keys ? keys : ''
                    }
                } );
            },
            
            populateAddUserList : function( crId )
            {
                const self = this;
                console.log( 'populateAddUserList', [ crId, self.auv, self.auv.filters[0].value ]);
                let filter = null;
                if ( self.auv.filters[0].value )
                    filter = self.auv.filters[0].value;
                const au = new Module( 'system' );
                au.onExecuted = ( s, d ) => {
                    console.log( 'populateAddUserList on exe', [ s, d ] );
                    const res = JSON.parse( d );
                    console.log( 'addulist', res );
                    const rws = [];
                    let l = res.length;
                    if ( !l )
                    {
                        self.auv.setRowData( rws );
                        return;
                    }
                    
                    
                    for( ;l; )
                    {
                        l--;
                        const uId = res[l].ID;
                        const cnf = [
                            {
                                type  : 'string',
                                value : res[l].FullName,
                            },
                            {
                                type     : 'checkbox',
                                value    : false,
                                onchange : 'cr_add_user_check_' + res[l].ID
                            },
                        ];
                        
                        rws.push( cnf );
                        
                        ccAddCallback( 'cr_add_user_check_' + res[l].ID, e =>
                        {
                            console.log( 'cr_add_user_check_', { 
                                e    : e, 
                                uid  : uId, 
                                crid : crId 
                            });
                            if ( !e )
                            {
                                const r = new Module( 'system' );
                                r.onExecuted = ( s, d ) =>
                                {
                                    console.log( 'rem user back', [ s, d ]);
                                }
                                r.execute( 'appmodule', {
                                    appName : 'CourseCreator',
                                    command : 'submodule',
                                    vars    : {
                                        submodule   : 'classrooms',
                                        method      : 'removeuser',
                                        classroomId : crId,
                                        userId      : uId,
                                    }
                                });
                            }
                            else
                            {
                                const a = new Module( 'system' );
                                a.onExecuted = ( s, d ) => 
                                {
                                    console.log( 'add user back', [ s, d ]);
                                }
                                a.execute( 'appmodule',
                                {
                                    appName : 'CourseCreator',
                                    command : 'submodule',
                                    vars    : {
                                        submodule : 'classrooms',
                                        method    : 'adduser',
                                        userId    : uId,
                                        classId   : crId,
                                    },
                                });
                            }
                        });
                    }
                    
                    self.auv.setRowData( rws );
                }
                
                au.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        submodule: 'classrooms',
                        method: 'findusers',
                        classroomId: crId,
                        keys: filter
                    }
                } );
            },
            
            addUser: function( userId, classroomId )
            {
            	let self = this;
            	let m = new Module( 'system' );
            	m.onExecuted = function( e, d )
            	{
            		self.clearFind();
            		self.refreshClassroomUsers();
            	}
            	m.execute( 'appmodule', {
            		appName: 'CourseCreator',
            		command: 'submodule',
            		vars: {
            			submodule: 'classrooms',
            			method: 'adduser',
            			userId: userId,
            			classroomId: classroomId
            		}
            	} );
            },
            clearFind: function()
            {
                document.querySelector( '.EditPane' ).classList.remove( 'Find' );
                ge( 'UserHeader' ).classList.remove( 'Two' );
                ge( 'UserHeader' ).classList.add( 'One' );
                this.refreshClassroomUsers();
            },
            findUsers: function()
            {
                ge( 'UserHeader' ).classList.add( 'Two' );
                ge( 'UserHeader' ).classList.remove( 'One' );
                
                document.querySelector( '.EditPane' ).classList.add( 'Find' );
                
                let searchParams = ge( 'userSearch' ).value;
                
                let m = new Module( 'system' );
                m.onExecuted = function( e, d )
                {
                    if( e == 'ok' )
                    {
                        let lis = JSON.parse( d );
                        let str = '';
                        console.log( 'findUsers', lis );
                        for( let a = 0; a < lis.length; a++ )
                        {
                            let name = lis[a].FullName;
                            let addbtn = '<button type="button" class="IconSmall fa-plus" onclick="Application.submodules.classrooms.addUser(\'' + lis[a].ID + '\',\'' + ge( 'ClassroomId' ).value + '\')">Add user to classroom</button>';
                            str += '<div class="HRow EditRow">\
                                <div class="HContent50 FloatLeft PaddingSmall Ellipsis">' + name + '</div>\
                                <div class="HContent50 FloatLeft TextRight PaddingSmall Ellipsis">' + addbtn + '</div>\
                            </div>';
                        }
                        
                        ge( 'ClassroomUsers' ).innerHTML = str;
                    }
                    else
                    {
                        ge( 'ClassroomUsers' ).innerHTML = '<div class="HRow EditRow"><div class="HContent100 Ellipsis">No search results.</div></div>';
                    }
                }
                m.execute( 'appmodule', {
                    appName: 'CourseCreator',
                    command: 'submodule',
                    vars: {
                        submodule: 'classrooms',
                        method: 'findusers',
                        classroomId: ge( 'ClassroomId' ).value,
                        keys: searchParams
                    }
                } );
            }
        };
        Application.submodules.classrooms.init();
    </script>
    <style>
        #UserHeader .Two,
        #UserHeader.Two .One
        {
            display: none;
        }
        #UserHeader.Two .Two
        {
            display: block;
        }
        
        .EditPane:not(.Find) .ClearFind { display: none; }
        .EditPane.Find .FindUsers { display: none; }
        
        /*
        span.Status,
        span.Payment
        {
            position: relative;
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 100%;
        }
        */
        
        .ButtonSpace
        {
            position: relative;
            text-align: center;
        }
        
        .ButtonSpace > span
        {
            padding: 2px 6px;
            background: var(--list-button-background);
            color: var(--list-button-color);
            margin-top: 2px;
            cursor: pointer;
            border-radius: 100%;
        }
        
        .ButtonSpace > span:hover
        {
            background: var(--list-button-background-hover);
            color: var(--list-button-color-hover);
        }
        
        /*
        span.Default
        {
            background-color: #bfbfbf;
        }
        span.Planned
        {
            background-color: #ff7700;
        }
        span.Started
        {
            background-color: #00aa00;
        }
        span.Completed
        {
            background-color: #009900;
        }
        */
        
    </style>

