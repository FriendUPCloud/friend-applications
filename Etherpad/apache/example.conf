<VirtualHost etherpad.friendospredator.com:443>
    ServerAdmin webmaster@localhost
	ServerName etherpad.example.com
	DocumentRoot /var/www/etherpad

	SSLEngine on
	SSLProxyEngine On
	
	SSLCertificateFile /home/user/folder/certificate.pem
	SSLCertificateKeyFile /home/user/folder/key.pem
	
	#SSLProxyVerify none
	#SSLProxyCheckPeerCN off
	#SSLProxyCheckPeerName off
	#SSLProxyCheckPeerExpire off


    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

	#FRIEND CONFIG
	Header set Access-Control-Allow-Origin "*"
	Header set Access-Control-Allow-Headers "method, origin, content-type, accept, options, Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With"
	Header set Access-Control-Allow-Methods "POST, GET, PATCH, DELETE, PUT, OPTIONS"
	SetEnv proxy-sendchunked
	SetEnv proxy-sendcl

	AllowEncodedSlashes NoDecode

	<Location />
		Order allow,deny
		Allow from all

		ProxyPass http://127.0.0.1:9001/ flushpackets=on
		ProxyPassReverse http://127.0.0.1:9001/
		
		AddOutputFilterByType SUBSTITUTE text/html
		Substitute "s|</html>|<script type=\"text/javascript\" src=\"https://etherpad.example.com/friend/friend-script.js\"></script></html>|ni"
	</Location>

	<Location /friend/>
		ProxyPass !
	</Location>


	<Location /socket.io>
		# This is needed to handle the websocket transport through the proxy, since
		# etherpad does not use a specific sub-folder, such as /ws/ to handle this kind of traffic.
		# Taken from https://github.com/ether/etherpad-lite/issues/2318#issuecomment-63548542
		# Thanks to beaugunderson for the semantics
		RewriteEngine On
		RewriteCond %{QUERY_STRING} transport=websocket    [NC]
		RewriteRule /(.*) ws://localhost:9001/socket.io/$1 [P,L]
		ProxyPass http://localhost:9001/socket.io retry=0 timeout=30
		ProxyPassReverse http://localhost:9001/socket.io
	</Location>

</VirtualHost>
# vim: syntax=apache ts=4 sw=4 sts=4 sr noet